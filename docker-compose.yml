services:
  # Services existants (extensions du docker-compose.yml de vexa)
  api-gateway:
    extends:
      file: ./vexa/docker-compose.yml
      service: api-gateway
    networks:
      - vexa_default
      - vexa_network

  bot-manager:
    extends:
      file: ./vexa/docker-compose.yml
      service: bot-manager
    environment:
      - BOT_LOGS_HOST_DIR=/Users/thibaud/Documents/development/gladia-meet-project/gladia-meet-bot/persistent_data/logs
      - BOT_SCREENSHOTS_HOST_DIR=/Users/thibaud/Documents/development/gladia-meet-project/gladia-meet-bot/persistent_data/screenshots
      - BOT_ENABLE_SCREENSHOTS=${BOT_ENABLE_SCREENSHOTS:-false}
      - GLADIA_API_URL=http://audio-router:8084
    volumes:
      - ./persistent_data:/opt/vexa-bot/persistent_data
    networks:
      - vexa_default
      - vexa_network

  admin-api:
    extends:
      file: ./vexa/docker-compose.yml
      service: admin-api
    networks:
      - vexa_default
      - vexa_network

  redis:
    extends:
      file: ./vexa/docker-compose.yml
      service: redis
    networks:
      - vexa_default
      - vexa_network

  postgres:
    extends:
      file: ./vexa/docker-compose.yml
      service: postgres
    networks:
      - vexa_default
      - vexa_network

  traefik:
    extends:
      file: ./vexa/docker-compose.yml
      service: traefik
    networks:
      - vexa_default
      - vexa_network

  # Nouveaux services dockeris√©s
  bot-launcher:
    container_name: new-vexa-bot-bot-launcher
    build:
      context: ./services
      dockerfile: bot-launcher/Dockerfile
    ports:
      - "9081:8080"
    environment:
      - API_GATEWAY_URL=http://api-gateway:8000
      - API_KEY=${API_KEY}
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-dev-secret-key-change-in-production}
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=vexa
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
    depends_on:
      - api-gateway
      - postgres
    networks:
      - vexa_network
      - vexa_default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bot-launcher.rule=Host(`bot-launcher.localhost`)"
      - "traefik.http.services.bot-launcher.loadbalancer.server.port=8080"

  log-monitor:
    container_name: new-vexa-bot-log-monitor
    build:
      context: ./services
      dockerfile: log-monitor/Dockerfile
    ports:
      - "9082:8080"
    environment:
      - API_KEY=${API_KEY}
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-dev-secret-key-change-in-production}
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=vexa
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - LOGS_DIR=/opt/vexa-bot/persistent_data/logs
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./persistent_data/logs:/opt/vexa-bot/persistent_data/logs:ro
    depends_on:
      - postgres
    networks:
      - vexa_network
      - vexa_default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.log-monitor.rule=Host(`log-monitor.localhost`)"
      - "traefik.http.services.log-monitor.loadbalancer.server.port=8080"

  transcript-retriever:
    container_name: new-vexa-bot-transcript-retriever
    build:
      context: ./services
      dockerfile: transcript-retriever/Dockerfile
    ports:
      - "9083:8080"
    environment:
      - API_GATEWAY_URL=http://api-gateway:8000
      - API_KEY=${API_KEY}
      - GLADIA_API_KEY=${GLADIA_API_KEY}
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-dev-secret-key-change-in-production}
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=vexa
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
    depends_on:
      - api-gateway
      - postgres
    networks:
      - vexa_network
      - vexa_default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.transcript-retriever.rule=Host(`transcript-retriever.localhost`)"
      - "traefik.http.services.transcript-retriever.loadbalancer.server.port=8080"

  admin-config:
    container_name: new-vexa-bot-admin-config
    build:
      context: ./services
      dockerfile: admin-config/Dockerfile
    ports:
      - "9087:8080"
    environment:
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-dev-secret-key-change-in-production}
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=postgres
      - DATABASE_NAME=vexa
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
    depends_on:
      - postgres
    networks:
      - vexa_network
      - vexa_default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin-config.rule=Host(`admin-config.localhost`)"
      - "traefik.http.services.admin-config.loadbalancer.server.port=8080"

  # ANCIEN SYSTEME BATCH - COMMENTE (remplace par whisper-streaming-proxy)
  # whisper-backend:
  #   container_name: new-vexa-bot-whisper-backend
  #   build:
  #     context: ./services/whisper-backend
  #     dockerfile: Dockerfile
  #   environment:
  #     - WHISPER_MODEL_SIZE=brandenkmurray/faster-whisper-large-v3-french-distil-dec16
  #     - REDIS_HOST=redis
  #     - REDIS_PORT=6379
  #   volumes:
  #     - ./whisper-cache:/root/.cache/huggingface
  #   restart: unless-stopped
  #   depends_on:
  #     - redis
  #   networks:
  #     - vexa_network
  #     - vexa_default

  # gladia-proxy:
  #   container_name: new-vexa-bot-gladia-proxy
  #   build:
  #     context: ./services/gladia-murmure-proxy
  #     dockerfile: Dockerfile
  #   ports:
  #     - "9084:8084"
  #   environment:
  #     - PORT=8084
  #     - WHISPER_API_URL=http://whisper-backend:5000
  #     - PROXY_PUBLIC_HOST=gladia-proxy:8084
  #   depends_on:
  #     - whisper-backend
  #   networks:
  #     - vexa_network
  #     - vexa_default

  # NOUVEAU SYSTEME STREAMING - Transcription temps reel

  # Audio Router - multiplexe l'audio vers les backends ASR
  audio-router:
    container_name: new-vexa-bot-audio-router
    build:
      context: ./services/audio-router
      dockerfile: Dockerfile
    ports:
      - "9084:8084"
    environment:
      - ASR_BACKENDS=whisper,voxtral
      - WHISPER_BACKEND_URL=http://whisper-streaming-proxy:8085
      - VOXTRAL_BACKEND_URL=http://voxtral-streaming-proxy:8086
    depends_on:
      - whisper-streaming-proxy
      - voxtral-streaming-proxy
    networks:
      - vexa_network
      - vexa_default

  # Whisper backend (local, GPU)
  whisper-streaming-proxy:
    container_name: new-vexa-bot-whisper-streaming-proxy
    build:
      context: ./services/whisper-streaming-proxy
      dockerfile: Dockerfile
    ports:
      - "9085:8085"
    environment:
      - WHISPER_MODEL_SIZE=brandenkmurray/faster-whisper-large-v3-french-distil-dec16
      - WHISPER_LANGUAGE=fr
      - BOT_MANAGER_CALLBACK_URL=http://bot-manager:8080/bots/internal/transcript
      - TRANSCRIPT_SOURCE=whisper
    volumes:
      - ./whisper-cache:/root/.cache/huggingface
    depends_on:
      - bot-manager
    networks:
      - vexa_network
      - vexa_default

  # Voxtral backend (Mistral API)
  voxtral-streaming-proxy:
    container_name: new-vexa-bot-voxtral-streaming-proxy
    build:
      context: ./services/voxtral-streaming-proxy
      dockerfile: Dockerfile
    ports:
      - "9086:8086"
    environment:
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - VOXTRAL_MODEL=voxtral-mini-transcribe-realtime-2602
      - VOXTRAL_LANGUAGE=fr
      - BOT_MANAGER_CALLBACK_URL=http://bot-manager:8080/bots/internal/transcript
      - TRANSCRIPT_SOURCE=voxtral
    depends_on:
      - bot-manager
    networks:
      - vexa_network
      - vexa_default

volumes:
  redis-data:
    name: new-redis-data
  postgres-data:
    name: new-postgres-data

networks:
  vexa_network:
    name: new-vexa-network
    driver: bridge
  vexa_default:
    name: new-vexa-default
    driver: bridge
